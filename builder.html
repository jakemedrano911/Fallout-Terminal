<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <title>Terminal Config Builder</title>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <style>
    @font-face{
      font-family:"FSEX300";
      src:url("fonts/FSEX300.ttf") format("truetype");
      font-weight:normal;
      font-style:normal;
    }
    :root{
      --text-color:#7aff7a;
      --terminal-bg:#041204;
      --border-color:#008800;
    }
    body {
      background-color: #f9fafb;
      color: #000000;
    }
    .dark body {
      background:var(--terminal-bg);
      color:var(--text-color);
      font-family:"FSEX300","IBM Plex Mono",ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace;
      background-image:repeating-linear-gradient(
        rgba(0,0,0,0.55) 0px,
        rgba(0,0,0,0.55) 1px,
        transparent 1px,
        transparent 4px
      );
    }
    fieldset {
      background-color: #f3f4f6;
      border-color: #d1d5db;
    }
    .dark fieldset {
      background-color: var(--terminal-bg);
      border:2px solid var(--border-color);
    }
    input, textarea, select {
      background-color: #f9fafb;
      border-color: #d1d5db;
      color: #000000;
    }
    .dark input, .dark textarea, .dark select {
      background-color: transparent;
      border:2px solid var(--border-color);
      color: var(--text-color);
    }
    ::placeholder {
      color: #4b5563;
      opacity: 1;
    }
    .dark ::placeholder {
      color: rgba(122,255,122,0.5);
    }
    .screen, .menu-item, .difficulty-item {
      transition: transform 0.2s;
      touch-action: none;
    }
    .drag-chosen {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .drag-ghost {
      opacity: 0.4;
      border: 2px dashed var(--border-color);
    }
    .dragging {
      user-select: none;
    }
      .action-btn {
        border: 1px solid #9ca3af;
        border-radius: 0.25rem;
        padding: 0 0.25rem;
        background-color: #f3f4f6;
        color: #000000;
      }
      .action-btn:hover {
        background-color: #e5e7eb;
      }
      .dark .action-btn {
        border:2px solid var(--border-color);
        background-color: var(--terminal-bg);
        color: var(--text-color);
        text-shadow:0 0 5px rgba(122,255,122,0.5);
      }
    .dark .action-btn:hover {
      background-color:#0a1f0a;
    }
    .top-line-btn {
      padding: 0.25rem 0.5rem;
      border: 2px solid #4b5563;
      border-radius: 0.25rem;
      background-color: #f3f4f6;
      color: #000000;
      cursor: pointer;
    }
    .top-line-btn:hover {
      background-color: #e5e7eb;
    }
    .dark .top-line-btn {
      border:2px solid var(--border-color);
      background-color: var(--terminal-bg);
      color: var(--text-color);
      text-shadow:0 0 5px rgba(122,255,122,0.5);
    }
    .dark .top-line-btn:hover {
      background-color:#0a1f0a;
    }

    .tab-btn {
      padding: 0.25rem 0.5rem;
      border: 2px solid #4b5563;
      border-bottom-width: 2px;
      border-radius: 0.25rem 0.25rem 0 0;
      background-color: #f3f4f6;
      color: #000000;
      cursor: pointer;
    }
    .tab-btn:hover {
      background-color: #e5e7eb;
    }
    .tab-btn-active {
      background-color: #ffffff;
      border-bottom-color: transparent;
      margin-bottom: -2px;
    }
    .dark .tab-btn {
      border:2px solid var(--border-color);
      border-bottom:none;
      background-color: var(--terminal-bg);
      color: var(--text-color);
      text-shadow:0 0 5px rgba(122,255,122,0.5);
      border-radius:0;
    }
    .dark .tab-btn:hover {
      background-color:#0a1f0a;
    }
    .dark .tab-btn-active {
      background-color:#0a1f0a;
      border-bottom-color: var(--terminal-bg);
      margin-bottom:-2px;
    }

    .dark #builder-wrapper {
      border:4px solid var(--border-color);
      border-radius:12px;
      padding:1rem;
      background:var(--terminal-bg);
      background-image:repeating-linear-gradient(
        rgba(0,0,0,0.55) 0px,
        rgba(0,0,0,0.55) 1px,
        transparent 1px,
        transparent 4px
      );
      box-shadow:0 0 10px rgba(0,255,0,0.2);
    }
    .dark #tabs-bar { border-bottom:2px solid var(--border-color); }
    .dark a { color: var(--text-color); }
    .dark #generate-feedback { color: var(--text-color); }
  </style>
</head>
<body class="m-0 p-4">
<div id="builder-wrapper" class="max-w-4xl mx-auto">
<h1 class="text-2xl font-bold mb-4">Config Builder</h1>
<div class="mb-4 flex gap-2 items-center">
  <button type="button" id="load-config" class="top-line-btn" title="Load configuration from a JSON file such as one previously exported.">Load Config</button>
  <button type="submit" form="builder-form" class="top-line-btn" title="Generate the configuration file and enable downloading config.json">Generate Config</button>
  <a id="download-link" class="hidden text-blue-600 underline" download="config.json">Download config.json</a>
  <span id="generate-feedback" class="text-green-600 hidden"></span>
  <button type="button" id="dark-toggle" class="top-line-btn" title="Toggle dark mode">Toggle Dark Mode</button>
</div>
<input type="file" id="config-file" accept="application/json" class="hidden">
<form id="builder-form">
    <div id="tabs-bar" class="mb-4 flex gap-2 border-b border-gray-300 dark:border-gray-700">
      <button type="button" @click="activeTab='content'" :class="['tab-btn', activeTab==='content' ? 'tab-btn-active' : '']">Terminal Content</button>
      <button type="button" @click="activeTab='boot'" :class="['tab-btn', activeTab==='boot' ? 'tab-btn-active' : '']">Boot</button>
      <button type="button" @click="activeTab='commands'" :class="['tab-btn', activeTab==='commands' ? 'tab-btn-active' : '']">Commands</button>
      <button type="button" @click="activeTab='hacking'" :class="['tab-btn', activeTab==='hacking' ? 'tab-btn-active' : '']">Hacking</button>
      <button type="button" @click="activeTab='prefs'" :class="['tab-btn', activeTab==='prefs' ? 'tab-btn-active' : '']">Preferences</button>
    </div>
  <div v-show="activeTab==='content'" class="space-y-4">
    <fieldset class="p-4 border rounded-lg shadow" title="Enter the lines displayed at the top of the terminal. Each line becomes a separate title line. Example: 'ROBCO INDUSTRIES UNIFIED OPERATING SYSTEM'.">
      <legend class="flex items-center gap-1">Titles</legend>
      <textarea id="titles" rows="4" cols="50" class="w-full p-2 border rounded" placeholder="Each line becomes a title line" title="Each line becomes a title line, e.g., ROBCO INDUSTRIES UNIFIED OPERATING SYSTEM"></textarea>
    </fieldset>
    <fieldset class="p-4 border rounded-lg shadow" title="Enter header text shown beneath the title. Each line becomes its own header line. Example: 'Welcome to the RobCo Engineering Division Database!'.">
      <legend class="flex items-center gap-1">Headers</legend>
      <textarea id="headers" rows="4" cols="50" class="w-full p-2 border rounded" placeholder="Each line becomes a header line" title="Each line becomes a header line such as 'Welcome to the RobCo Engineering Division Database!'"></textarea>
    </fieldset>
    <fieldset class="p-4 border rounded-lg shadow" title="Define screens and their menu options. Use screen IDs to link options to other screens or leave blank for plain text. Example: a 'help' screen with a RETURN option.">
      <legend class="flex items-center gap-1">Screens</legend>
      <div id="screens-container">
        <template v-for="(screen, sIdx) in screens">
          <div :key="screen.uid" class="screen mb-4 border border-l-4 rounded p-2 text-white" :style="{borderColor: screen.color, backgroundColor: screen.color}">
            <div class="mb-2">
              <div class="flex flex-wrap items-center mb-2">
                <button type="button" @click="screen.open = !screen.open" class="mr-2 action-btn" :aria-expanded="screen.open">{{screen.open ? '▼' : '►' }}</button>
                <input v-model="screen.id" class="screen-id flex-1 border rounded p-1 mr-2" placeholder="Screen ID">
                <input type="color" v-model="screen.color" class="screen-color w-8 h-8 p-0 border-2 rounded mr-2 shadow cursor-pointer" title="Color is for organization only and does not affect terminal appearance">
                <input type="text" v-model="screen.color" class="w-20 p-1 border rounded mr-2" title="Color is for organization only and does not affect terminal appearance">
                <button type="button" @click="moveScreenUp(sIdx)" :disabled="sIdx===0" class="mr-1 action-btn" title="Move up">▲</button>
                <button type="button" @click="moveScreenDown(sIdx)" :disabled="sIdx===screens.length-1" class="mr-1 action-btn" title="Move down">▼</button>
                <button type="button" @click="removeScreen(sIdx)" class="action-btn" title="Remove screen"><span class="w-4 h-4 flex items-center justify-center text-black dark:text-white">&times;</span></button>
              </div>
              <div class="flex flex-wrap items-center">
                <label class="flex items-center mr-2">Text:
                  <input type="color" v-model="screen.textColor" class="ml-1">
                  <input type="text" v-model="screen.textColor" class="ml-1 border rounded p-1 w-24">
                </label>
                <label class="flex items-center mr-2">Background:
                  <input type="color" v-model="screen.bgColor" class="ml-1">
                  <input type="text" v-model="screen.bgColor" class="ml-1 border rounded p-1 w-24">
                </label>
                <label class="flex items-center mr-2">Border:
                  <input type="color" v-model="screen.borderColor" class="ml-1">
                  <input type="text" v-model="screen.borderColor" class="ml-1 border rounded p-1 w-24">
                </label>
              </div>
            </div>
            <div v-show="screen.open" class="pl-6 items-container" :data-sidx="sIdx" :id="'items-'+screen.uid">
              <template v-for="(item, iIdx) in screen.items">
                <div :key="item.uid" class="menu-item mb-1 flex flex-wrap items-center gap-1 border p-1 rounded text-white" :style="{backgroundColor: screen.color, borderColor: screen.color}">
                  <textarea v-model="item.text" rows="2" cols="30" class="menu-text mr-1 border rounded p-1 flex-1" placeholder="Menu text"></textarea>
                  <input v-model="item.screen" class="menu-screen mr-1 border rounded p-1 w-24" placeholder="Screen id">
                  <input v-model="item.command" class="menu-command mr-1 border rounded p-1 w-32" placeholder="Command">
                  <button type="button" @click="moveMenuItemUp(sIdx, iIdx)" :disabled="iIdx===0" class="mr-1 action-btn" title="Move up">▲</button>
                  <button type="button" @click="moveMenuItemDown(sIdx, iIdx)" :disabled="iIdx===screen.items.length-1" class="mr-1 action-btn" title="Move down">▼</button>
                  <button type="button" @click="removeMenuItem(sIdx, iIdx)" class="action-btn" title="Remove item"><span class="w-4 h-4 flex items-center justify-center text-black dark:text-white">&times;</span></button>
                </div>
              </template>
              <button type="button" @click="addMenuItem(screen)" class="mt-2 px-2 py-1 border rounded">Add Menu Item</button>
            </div>
          </div>
        </template>
        <button type="button" @click="addScreen()" class="mt-2 px-2 py-1 border rounded">Add Screen</button>
      </div>
    </fieldset>
  </div>
  <div v-show="activeTab==='boot'" class="space-y-4">
    <fieldset class="p-4 border rounded-lg shadow">
      <legend class="flex items-center gap-1">Boot Sequence</legend>
      <div v-for="(step, idx) in bootSequence" :key="step.uid" class="flex items-center flex-wrap gap-1 mb-1">
        <textarea v-model="step.text" rows="2" cols="40" class="border rounded p-1 flex-1" placeholder="Boot text"></textarea>
        <select v-model="step.type" class="border rounded p-1">
          <option value="terminal">Terminal</option>
          <option value="user">User</option>
        </select>
        <button type="button" @click="moveBootStepUp(bootSequence, idx)" :disabled="idx===0" class="action-btn">▲</button>
        <button type="button" @click="moveBootStepDown(bootSequence, idx)" :disabled="idx===bootSequence.length-1" class="action-btn">▼</button>
        <button type="button" @click="removeBootStep(bootSequence, idx)" class="action-btn"><span class="w-4 h-4 flex items-center justify-center text-black dark:text-white">&times;</span></button>
      </div>
      <button type="button" @click="addBootStep(bootSequence)" class="mt-2 px-2 py-1 border rounded">Add Entry</button>
    </fieldset>
    <fieldset class="p-4 border rounded-lg shadow">
      <legend class="flex items-center gap-1">Locked Boot Sequence</legend>
      <div v-for="(step, idx) in lockedBootSequence" :key="step.uid" class="flex items-center flex-wrap gap-1 mb-1">
        <textarea v-model="step.text" rows="2" cols="40" class="border rounded p-1 flex-1" placeholder="Boot text"></textarea>
        <select v-model="step.type" class="border rounded p-1">
          <option value="terminal">Terminal</option>
          <option value="user">User</option>
        </select>
        <button type="button" @click="moveBootStepUp(lockedBootSequence, idx)" :disabled="idx===0" class="action-btn">▲</button>
        <button type="button" @click="moveBootStepDown(lockedBootSequence, idx)" :disabled="idx===lockedBootSequence.length-1" class="action-btn">▼</button>
        <button type="button" @click="removeBootStep(lockedBootSequence, idx)" class="action-btn"><span class="w-4 h-4 flex items-center justify-center text-black dark:text-white">&times;</span></button>
      </div>
      <button type="button" @click="addBootStep(lockedBootSequence)" class="mt-2 px-2 py-1 border rounded">Add Entry</button>
    </fieldset>
  </div>
  <div v-show="activeTab==='commands'" class="space-y-4">
    <fieldset class="p-4 border rounded-lg shadow">
      <legend class="flex items-center gap-1">Commands</legend>
      <div v-for="(cmd,idx) in commands" :key="cmd.uid" class="flex items-center flex-wrap gap-2 mb-2">
        <input v-model="cmd.name" class="border rounded p-1 w-32" placeholder="Command">
        <input v-model="cmd.screen" class="border rounded p-1 w-32" placeholder="Screen ID">
        <input v-model="cmd.command" class="border rounded p-1 flex-1" placeholder="Response">
        <label class="flex items-center gap-1"><input type="checkbox" v-model="cmd.help">Help</label>
        <label class="flex items-center gap-1"><input type="checkbox" v-model="cmd.hacking">Hacking</label>
        <button type="button" @click="moveCommandUp(idx)" :disabled="idx===0" class="mr-1 action-btn" title="Move up">▲</button>
        <button type="button" @click="moveCommandDown(idx)" :disabled="idx===commands.length-1" class="mr-1 action-btn" title="Move down">▼</button>
        <button type="button" @click="removeCommand(idx)" class="action-btn" title="Remove command"><span class="w-4 h-4 flex items-center justify-center text-black dark:text-white">&times;</span></button>
      </div>
      <button type="button" @click="addCommand" class="mt-2 action-btn">Add Command</button>
    </fieldset>
  </div>
  <div v-show="activeTab==='hacking'" class="space-y-4">
    <fieldset class="p-4 border rounded-lg shadow" title="Configure hacking settings for locked terminals.">
      <legend class="flex items-center gap-1">Hacking</legend>
      <label class="block" title="If checked, the terminal starts locked and requires hacking before use."><input type="checkbox" id="locked" checked class="mr-1"> Locked</label>
      <label id="difficulty-label" class="block" :title="difficultyTitle">Difficulty:
        <select id="difficulty" v-model="difficultyChoice" class="border rounded p-1 ml-2" :title="difficultyTitle">
          <option v-for="opt in difficultyOptions" :key="opt">{{ opt }}</option>
        </select>
      </label>
      <label class="block" title="Starting number of attempts available to the user.">Attempts: <input type="number" id="attempts" min="1" value="4" class="ml-2 border rounded p-1 w-20"></label>
      <label class="block" title="Maximum number of attempts allowed.">Max Attempts: <input type="number" id="max-attempts" min="1" value="4" class="ml-2 border rounded p-1 w-20"></label>
      <label class="block" title="Password needed to unlock the terminal after hacking, e.g., HARDWARE.">Password: <input type="text" id="password" class="ml-2 border rounded p-1"></label>
      <label class="block" title="Comma-separated words that will be removed as duds during hacking, e.g., RESEARCH, SCIENTIST.">Dud Words: <input type="text" id="dud-words" placeholder="WORD1, WORD2" class="ml-2 border rounded p-1"></label>
      <label class="block" title="Header text shown at the top of the hacking screen.">Hacking Header: <input type="text" id="hacking-header-input" v-model="hackingHeader" class="ml-2 border rounded p-1"></label>
      <label class="block">Hacking Text Color:
        <input type="color" id="hack-text-color" class="ml-2" v-model="hackTextColor">
        <input type="text" id="hack-text-color-hex" class="ml-2 border rounded p-1 w-24" v-model="hackTextColor">
      </label>
      <label class="block">Hacking Background Color:
        <input type="color" id="hack-bg-color" class="ml-2" v-model="hackBgColor">
        <input type="text" id="hack-bg-color-hex" class="ml-2 border rounded p-1 w-24" v-model="hackBgColor">
      </label>
      <label class="block">Hacking Border Color:
        <input type="color" id="hack-border-color" class="ml-2" v-model="hackBorderColor">
        <input type="text" id="hack-border-color-hex" class="ml-2 border rounded p-1 w-24" v-model="hackBorderColor">
      </label>
      <div id="dud-warning" class="text-red-600 hidden"></div>
      <button type="button" @click="showDifficulties = !showDifficulties" class="mt-2 px-2 py-1 border rounded" title="Edit difficulty levels">Customize Difficulties</button>
        <fieldset id="difficulties-fieldset" class="p-4 border rounded-lg shadow mt-4" title="Define hacking difficulty levels. Each level has a name, word count range, and password length range." v-show="showDifficulties">
          <legend class="flex items-center gap-1">Difficulties</legend>
          <div id="difficulties-container">
            <div v-for="(d, idx) in difficulties" :key="d.uid" class="difficulty-item mb-2 p-2 border rounded bg-gray-50 dark:bg-gray-800">
              <div class="flex items-center mb-2">
                <button type="button" @click="d.open = !d.open" class="mr-2 action-btn">{{ d.open ? '▼' : '►' }}</button>
                <input v-model="d.name" class="diff-name mr-2 border rounded p-1" placeholder="Name">
                <button type="button" @click="removeDifficulty(idx)" class="action-btn" title="Remove difficulty"><span class="w-4 h-4 flex items-center justify-center text-black dark:text-white">&times;</span></button>
              </div>
              <div v-show="d.open" class="pl-6 space-y-1">
                <label class="block">Words: <input type="number" v-model.number="d.wordCount[0]" class="word-min mr-1 border rounded p-1 w-16" min="1"> - <input type="number" v-model.number="d.wordCount[1]" class="word-max border rounded p-1 w-16" min="1"></label>
                <label class="block">Length: <input type="number" v-model.number="d.length[0]" class="len-min mr-1 border rounded p-1 w-16" min="1"> - <input type="number" v-model.number="d.length[1]" class="len-max border rounded p-1 w-16" min="1"></label>
              </div>
            </div>
            <button type="button" @click="addDifficulty()" class="mt-2 px-2 py-1 border rounded">Add Difficulty</button>
          </div>
        </fieldset>
    </fieldset>
  </div>
  <div v-show="activeTab==='prefs'" class="space-y-4">
    <fieldset class="p-4 border rounded-lg shadow" title="Customize terminal appearance.">
      <legend class="flex items-center gap-1">Default Appearance</legend>
      <label class="block" title="Color of text displayed in the terminal, e.g., #7aff7a.">Default Text Color:
        <input type="color" id="text-color" class="ml-2" v-model="textColor">
        <input type="text" id="text-color-hex" class="ml-2 border rounded p-1 w-24" v-model="textColor">
      </label>
      <label class="block" title="Color of the terminal window outline, e.g., #008800.">Default Outline Color:
        <input type="color" id="border-color" class="ml-2" v-model="borderColor">
        <input type="text" id="border-color-hex" class="ml-2 border rounded p-1 w-24" v-model="borderColor">
      </label>
      <label class="block" title="Background color of the terminal window, e.g., #041204.">Default Background Color:
        <input type="color" id="bg-color" class="ml-2" v-model="bgColor">
        <input type="text" id="bg-color-hex" class="ml-2 border rounded p-1 w-24" v-model="bgColor">
      </label>
    </fieldset>
  </div>
</form>
</div>
<script>
const defaultDifficulties = [
  { name: "Very Easy", wordCount: [8,10], length: [4,5] },
  { name: "Easy", wordCount: [10,12], length: [6,7] },
  { name: "Average", wordCount: [12,14], length: [8,9] },
  { name: "Hard", wordCount: [15,17], length: [10,11] },
  { name: "Very Hard", wordCount: [17,20], length: [12,15] }
];
const DEFAULT_TEXT_COLOR = '#7aff7a';
const DEFAULT_BG_COLOR = '#041204';
const DEFAULT_BORDER_COLOR = '#008800';
const BASE_SCREEN_COLOR = '#0c2c5f';

// Adjust the base color by a given amount and introduce a slight random
// variation in each channel so that successive screens are easier to
// differentiate.
function shadeColor(col, amt) {
  const num = parseInt(col.slice(1), 16);
  const vary = () => Math.floor(Math.random() * 30) - 15; // -15 to +14
  let r = (num >> 16) + amt + vary();
  let g = (num >> 8 & 0x00ff) + amt + vary();
  let b = (num & 0x0000ff) + amt + vary();
  r = Math.max(0, Math.min(255, r));
  g = Math.max(0, Math.min(255, g));
  b = Math.max(0, Math.min(255, b));
  return '#' + (r << 16 | g << 8 | b).toString(16).padStart(6, '0');
}

const app = Vue.createApp({
  data() {
    return {
        activeTab: 'content',
        screens: [],
        bootSequence:[{text:'',type:'terminal',uid:crypto.randomUUID?crypto.randomUUID():Math.random()}],
        lockedBootSequence:[{text:'',type:'terminal',uid:crypto.randomUUID?crypto.randomUUID():Math.random()}],
        commands: [
          {name:'back',screen:'',command:'',help:false,hacking:false,action:'back',uid:crypto.randomUUID?crypto.randomUUID():Math.random()},
          {name:'help',screen:'',command:'',help:true,hacking:false,action:'help',uid:crypto.randomUUID?crypto.randomUUID():Math.random()},
          {name:'?',screen:'',command:'',help:true,hacking:false,action:'help',uid:crypto.randomUUID?crypto.randomUUID():Math.random()},
          {name:'syntaxhelper',screen:'',command:'',help:false,hacking:true,action:'syntaxhelper',uid:crypto.randomUUID?crypto.randomUUID():Math.random()},
          {name:'ADMIN OVERRIDE',screen:'',command:'Access granted.',help:false,hacking:true,action:'adminoverride',uid:crypto.randomUUID?crypto.randomUUID():Math.random()},
          {name:'ADMIN ALLOWANCES',screen:'',command:'Allowances set to 99.',help:false,hacking:true,action:'adminallowances',uid:crypto.randomUUID?crypto.randomUUID():Math.random()}
        ],
        difficulties: [],
        difficultyChoice: 'Average',
        showDifficulties: false,
        textColor: DEFAULT_TEXT_COLOR,
        bgColor: DEFAULT_BG_COLOR,
        borderColor: DEFAULT_BORDER_COLOR,
        hackTextColor: DEFAULT_TEXT_COLOR,
        hackBgColor: DEFAULT_BG_COLOR,
        hackBorderColor: DEFAULT_BORDER_COLOR,
        hackingHeader: ''
      };
    },
  computed: {
    difficultyOptions() {
      return ['Random', ...this.difficulties.map(d => d.name)];
    },
    difficultyTitle() {
      return this.difficulties.map(d => `${d.name} (${d.length[0]}-${d.length[1]} letters, ${d.wordCount[0]}-${d.wordCount[1]} words)`).join('; ') + '; Random selects any difficulty.';
    }
  },
  methods: {
      addScreen(id='') {
        const text = this.textColor || DEFAULT_TEXT_COLOR;
        const bg = this.bgColor || DEFAULT_BG_COLOR;
        const border = this.borderColor || DEFAULT_BORDER_COLOR;
        // Use a larger offset to make the shade differences more pronounced.
        const offset = (this.screens.length % 10) * 20;
        const color = shadeColor(BASE_SCREEN_COLOR, offset);
        this.screens.push({
          id,
          color,
          items:[{text:'', screen:'', command:'', uid:crypto.randomUUID?crypto.randomUUID():Math.random()}],
          open:true,
          uid:crypto.randomUUID?crypto.randomUUID():Math.random(),
          textColor:text,
          bgColor:bg,
          borderColor:border
        });
        this.$nextTick(this.initSortables);
      },
      removeScreen(idx) {
        this.screens.splice(idx,1);
        this.$nextTick(this.initSortables);
      },
      addCommand() {
        this.commands.push({name:'',screen:'',command:'',help:false,hacking:false,action:'',uid:crypto.randomUUID?crypto.randomUUID():Math.random()});
      },
      removeCommand(idx) {
        this.commands.splice(idx,1);
      },
      moveCommandUp(idx) {
        if (idx <= 0) return;
        const arr = this.commands;
        [arr[idx - 1], arr[idx]] = [arr[idx], arr[idx - 1]];
      },
      moveCommandDown(idx) {
        if (idx >= this.commands.length - 1) return;
        const arr = this.commands;
        [arr[idx], arr[idx + 1]] = [arr[idx + 1], arr[idx]];
      },
      addMenuItem(screen) {
        screen.items.push({text:'', screen:'', command:'', uid:crypto.randomUUID?crypto.randomUUID():Math.random()});
        this.$nextTick(this.initSortables);
      },
        removeMenuItem(sIdx, iIdx) {
          this.screens[sIdx].items.splice(iIdx,1);
          this.$nextTick(this.initSortables);
        },
        moveScreenUp(idx) {
          if (idx <= 0) return;
          const arr = this.screens;
          [arr[idx - 1], arr[idx]] = [arr[idx], arr[idx - 1]];
          this.$nextTick(this.initSortables);
        },
        moveScreenDown(idx) {
          if (idx >= this.screens.length - 1) return;
          const arr = this.screens;
          [arr[idx], arr[idx + 1]] = [arr[idx + 1], arr[idx]];
          this.$nextTick(this.initSortables);
        },
        moveMenuItemUp(sIdx, iIdx) {
          if (iIdx <= 0) return;
          const items = this.screens[sIdx].items;
          [items[iIdx - 1], items[iIdx]] = [items[iIdx], items[iIdx - 1]];
          this.$nextTick(this.initSortables);
        },
        moveMenuItemDown(sIdx, iIdx) {
          const items = this.screens[sIdx].items;
          if (iIdx >= items.length - 1) return;
          [items[iIdx], items[iIdx + 1]] = [items[iIdx + 1], items[iIdx]];
          this.$nextTick(this.initSortables);
        },
        addBootStep(seq) {
        seq.push({text:'', type:'terminal', uid:crypto.randomUUID?crypto.randomUUID():Math.random()});
        this.$nextTick(this.initSortables);
        },
        removeBootStep(seq, idx) {
        seq.splice(idx,1);
        this.$nextTick(this.initSortables);
        },
        moveBootStepUp(seq, idx) {
        if(idx<=0) return;
        [seq[idx-1], seq[idx]] = [seq[idx], seq[idx-1]];
        this.$nextTick(this.initSortables);
        },
        moveBootStepDown(seq, idx) {
        if(idx>=seq.length-1) return;
        [seq[idx], seq[idx+1]] = [seq[idx+1], seq[idx]];
        this.$nextTick(this.initSortables);
        },
        initSortables() {
        },
      addDifficulty(d={name:'', wordCount:[1,1], length:[1,1]}) {
        this.difficulties.push({...d, open:false, uid:crypto.randomUUID?crypto.randomUUID():Math.random()});
        this.$nextTick(this.initSortables);
      },
      removeDifficulty(idx) {
        this.difficulties.splice(idx,1);
        this.$nextTick(this.initSortables);
      },
      loadConfig(config) {
        document.getElementById('titles').value = (config.titleLines || []).join('\n');
        document.getElementById('headers').value = (config.headerLines || []).join('\n');
        this.bootSequence = (config.bootSequence || []).map(s=>({...s, uid:crypto.randomUUID?crypto.randomUUID():Math.random()}));
        this.lockedBootSequence = (config.lockedBootSequence || []).map(s=>({...s, uid:crypto.randomUUID?crypto.randomUUID():Math.random()}));
        if(!this.bootSequence.length) this.bootSequence.push({text:'',type:'terminal',uid:crypto.randomUUID?crypto.randomUUID():Math.random()});
        if(!this.lockedBootSequence.length) this.lockedBootSequence.push({text:'',type:'terminal',uid:crypto.randomUUID?crypto.randomUUID():Math.random()});
        this.screens = [];
        this.commands = [];
        const style = config.style || {};
        const globalText = style.textColor || DEFAULT_TEXT_COLOR;
        const globalBg = style.backgroundColor || DEFAULT_BG_COLOR;
        const globalBorder = style.borderColor || DEFAULT_BORDER_COLOR;
        this.textColor = globalText;
        this.bgColor = globalBg;
        this.borderColor = globalBorder;
        const hackingStyle = config.hackingStyle || {};
        this.hackTextColor = hackingStyle.textColor || globalText;
        this.hackBgColor = hackingStyle.backgroundColor || globalBg;
        this.hackBorderColor = hackingStyle.borderColor || globalBorder;
        this.hackingHeader = (config.hacking && config.hacking.header) || '';
        Object.entries(config.screens || {}).forEach(([id, data]) => {
          const screen = {id, color:'#0c2c5f', items:[], open:true, uid:crypto.randomUUID?crypto.randomUUID():Math.random(), textColor:globalText, bgColor:globalBg, borderColor:globalBorder};
          const items = Array.isArray(data) ? data : (data.items || []);
          if(!Array.isArray(data) && data.style){
            if(data.style.textColor) screen.textColor = data.style.textColor;
            if(data.style.backgroundColor) screen.bgColor = data.style.backgroundColor;
            if(data.style.borderColor) screen.borderColor = data.style.borderColor;
          }
          items.forEach(item=>{
            if (typeof item === 'string') {
              screen.items.push({text:item, screen:'', command:'', uid:crypto.randomUUID?crypto.randomUUID():Math.random()});
            } else {
              screen.items.push({
                text: item.text || '',
                screen: item.screen || '',
                command: item.command || '',
                uid: crypto.randomUUID?crypto.randomUUID():Math.random()
              });
            }
          });
          if(!screen.items.length) screen.items.push({text:'', screen:'', command:'', uid:crypto.randomUUID?crypto.randomUUID():Math.random()});
          this.screens.push(screen);
        });
        Object.entries(config.commands || {}).forEach(([name, info])=>{
          this.commands.push({
            name,
            screen: info.screen || '',
            command: info.command || '',
            help: !!info.help,
            hacking: !!info.hacking,
            action: info.action || '',
            uid: crypto.randomUUID?crypto.randomUUID():Math.random()
          });
        });
        document.getElementById('locked').checked = config.locked || false;
        const diffs = config.hacking?.difficulties || defaultDifficulties;
        this.difficulties = [];
        diffs.forEach(d=>this.addDifficulty(d));
        this.difficultyChoice = config.hacking?.difficulty ?? 'Random';
        attemptsEl.value = config.hacking?.attempts ?? 4;
        maxAttemptsEl.value = config.hacking?.maxAttempts ?? 4;
        passwordEl.value = config.hacking?.password || '';
        dudWordsEl.value = (config.hacking?.dudWords || []).join(', ');
        this.$nextTick(this.initSortables);
      },
      handleSubmit() {
      if (!validateDudWords()) {
        dudWordsEl.reportValidity();
        return;
      }
      const rawTitles = document.getElementById('titles').value.split('\n');
      const titles = rawTitles.length === 1 && rawTitles[0] === '' ? [] : rawTitles;
      const rawHeaders = document.getElementById('headers').value.split('\n');
      const headers = rawHeaders.length === 1 && rawHeaders[0] === '' ? [] : rawHeaders;
      const bootSeq = this.bootSequence.filter(s=>s.text.trim()).map(s=>({text:s.text, type:s.type}));
      const lockedBootSeq = this.lockedBootSequence.filter(s=>s.text.trim()).map(s=>({text:s.text, type:s.type}));
      const textColor = this.textColor || DEFAULT_TEXT_COLOR;
      const backgroundColor = this.bgColor || DEFAULT_BG_COLOR;
      const borderColor = this.borderColor || DEFAULT_BORDER_COLOR;
      const hackTextColor = this.hackTextColor || textColor;
      const hackBgColor = this.hackBgColor || backgroundColor;
      const hackBorderColor = this.hackBorderColor || borderColor;
      const screensObj = {};
      this.screens.forEach(scr=>{
        const id = scr.id.trim();
        if(!id) return;
        const items=[];
        scr.items.forEach(it=>{
          const text=(it.text||'').trimEnd();
          const screen=(it.screen||'').trim();
          const command=(it.command||'').trim();
          if(!text && !screen && !command) return;
          if(screen && command){ items.push({text,screen,command}); }
          else if(screen){ items.push({text,screen}); }
          else if(command){ items.push({text,command}); }
          else { items.push(text); }
        });
        const style = {};
        if(scr.textColor !== textColor) style.textColor = scr.textColor;
        if(scr.bgColor !== backgroundColor) style.backgroundColor = scr.bgColor;
        if(scr.borderColor !== borderColor) style.borderColor = scr.borderColor;
        screensObj[id] = Object.keys(style).length ? {items, style} : items;
      });
      const commandsObj = {};
      this.commands.forEach(c=>{
        const name=(c.name||'').trim();
        if(!name) return;
        const screen=(c.screen||'').trim();
        const message=(c.command||'').trim();
        const action=(c.action||'').trim();
        const obj={};
        if(screen) obj.screen=screen;
        if(message) obj.command=message;
        if(action) obj.action=action;
        if(c.help) obj.help=true;
        if(c.hacking) obj.hacking=true;
        if(Object.keys(obj).length) commandsObj[name]=obj;
      });
      const diffValue = this.difficultyChoice;
      const difficulty = diffValue === 'Random' ? undefined : diffValue;
      const password = passwordEl.value.trim();
      const dudWords = dudWordsEl.value.split(',').map(s=>s.trim()).filter(Boolean);
      const attempts = parseInt(attemptsEl.value,10);
      const maxAttempts = parseInt(maxAttemptsEl.value,10);
      const locked = document.getElementById('locked').checked;
      const style = { textColor, backgroundColor, borderColor };
      const hackingStyle = {
        textColor: hackTextColor,
        backgroundColor: hackBgColor,
        borderColor: hackBorderColor
      };
      const hacking = { difficulties: this.difficulties.map(({name, wordCount, length})=>({name, wordCount, length})) };
      if (difficulty) hacking.difficulty = difficulty;
      if (!isNaN(attempts) && attempts !== 4) hacking.attempts = attempts;
      if (!isNaN(maxAttempts) && maxAttempts !== 4) hacking.maxAttempts = maxAttempts;
      if (password) hacking.password = password;
      if (dudWords.length) hacking.dudWords = dudWords;
      if (this.hackingHeader) hacking.header = this.hackingHeader;
      const config = {
        titleLines: titles,
        headerLines: headers,
        bootSequence: bootSeq,
        lockedBootSequence: lockedBootSeq,
        screens: screensObj,
        style,
        hackingStyle,
        locked,
        hacking
      };
      if(Object.keys(commandsObj).length) config.commands = commandsObj;
      const blob = new Blob([JSON.stringify(config, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const dl = document.getElementById('download-link');
      dl.href = url;
      dl.classList.remove('hidden');
      const feedback = document.getElementById('generate-feedback');
      feedback.textContent = `Generated ${new Date().toLocaleTimeString()}`;
      feedback.classList.remove('hidden');
    }
  },
  mounted() {
    this.addScreen('menu');
    defaultDifficulties.forEach(d=>this.addDifficulty(d));
    this.$nextTick(this.initSortables);
  }
});

const vm = app.mount('#builder-form');

document.getElementById('builder-form').addEventListener('submit', e => {
  e.preventDefault();
  vm.handleSubmit();
});
document.getElementById('load-config').addEventListener('click', () => document.getElementById('config-file').click());
document.getElementById('config-file').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
    reader.onload = () => {
      const config = JSON.parse(reader.result);
      vm.loadConfig(config);
    };
  reader.readAsText(file);
});
document.getElementById('dark-toggle').addEventListener('click', ()=> document.documentElement.classList.toggle('dark'));

const passwordEl = document.getElementById('password');
const dudWordsEl = document.getElementById('dud-words');
const dudWarningEl = document.getElementById('dud-warning');
const attemptsEl = document.getElementById('attempts');
const maxAttemptsEl = document.getElementById('max-attempts');

function validateDudWords() {
  const password = passwordEl.value.trim();
  const duds = dudWordsEl.value.split(',').map(s => s.trim()).filter(Boolean);
  let msg = '';
  if (duds.length > 0) {
    if (password) {
      const len = password.length;
      if (duds.some(w => w.length !== len)) {
        msg = 'Dud words must match the password length.';
      }
    } else {
      const len = duds[0].length;
      if (duds.some(w => w.length !== len)) {
        msg = 'All dud words must be the same length.';
      }
    }
  }
  dudWordsEl.setCustomValidity(msg);
  dudWarningEl.textContent = msg;
  dudWarningEl.classList.toggle('hidden', !msg);
  return !msg;
}

passwordEl.addEventListener('input', validateDudWords);
dudWordsEl.addEventListener('input', validateDudWords);
</script>
</body>
</html>
